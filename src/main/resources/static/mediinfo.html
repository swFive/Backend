<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>약 정보 입력</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; max-width: 600px; }
        form { display: flex; flex-direction: column; gap: 15px; }
        div { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="time"], input[type="date"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; }
        .days button { margin-right: 5px; padding: 10px; border-radius: 50%; border: 1px solid #ccc; background-color: white; cursor: pointer; width: 40px; height: 40px; }
        .days button.active { background-color: #007bff; border-color: #007bff; color: white; }
        button[type="submit"] { padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 1.1em; cursor: pointer; }
        button[type="submit"]:hover { background-color: #0056b3; }
        #time-container { gap: 10px; }
    </style>
</head>
<body>

<h2>새 약 추가</h2>

<form id="medicineForm" onsubmit="return handleSubmit(event)">

    <div>
        <label for="category">카테고리</label>
        <input type="text" id="category" name="category" placeholder="예: 영양제, 처방약" required />
    </div>

    <div>
        <label for="name">약 이름</label>
        <input type="text" id="name" name="name" placeholder="예: 타이레놀" required />
    </div>

    <div>
        <label for="doseUnitQuantity">1회 복용량(정)</label>
        <input type="number" id="doseUnitQuantity" name="doseUnitQuantity" min="0" value="1" required />
    </div>

    <div>
        <label for="initialQuantity">총 재고(정)</label>
        <input type="number" id="initialQuantity" name="initialQuantity" min="0" value="30" required />
    </div>

    <div>
        <label for="memo">메모 (선택)</label>
        <input type="text" id="memo" name="memo" placeholder="예: 식후 즉시 복용" />
    </div>

    <hr/>
    <h3>복용 규칙</h3>

    <div>
        <label>복용 시간 (1개 이상)</label>
        <input type="time" class="time-input" required />
        <button type="button" onclick="addTime()">+ 시간 추가</button>
        <div id="time-container"></div>
    </div>

    <div>
        <label>복용 요일</label>
        <div class="days">
            <button type="button" onclick="toggleDay(this)">월</button>
            <button type="button" onclick="toggleDay(this)">화</button>
            <button type="button" onclick="toggleDay(this)">수</button>
            <button type="button" onclick="toggleDay(this)">목</button>
            <button type="button" onclick="toggleDay(this)">금</button>
            <button type="button" onclick="toggleDay(this)">토</button>
            <button type="button" onclick="toggleDay(this)">일</button>
        </div>
        <input type="hidden" id="selectedDays" required>
    </div>

    <div>
        <label>복용 기간</label>
        시작일: <input type="date" id="startDate" name="startDate" required />
        종료일: <input type="date" id="endDate" name="endDate" required />
    </div>

    <button type="submit">저장하기</button>
</form>

<script>
    function addTime() {
        const container = document.getElementById("time-container");
        const input = document.createElement("input");
        input.type = "time";
        input.classList.add("time-input");
        container.appendChild(input);
    }

    function toggleDay(button) {
        button.classList.toggle("active");
        const selected = [];
        document.querySelectorAll(".days button.active").forEach(btn => {
            selected.push(btn.innerText);
        });
        const daysString = selected.join(",");
        document.getElementById("selectedDays").value = daysString;

        if (daysString) {
            document.getElementById("selectedDays").removeAttribute("required");
        } else {
            document.getElementById("selectedDays").setAttribute("required", "true");
        }
    }

    function handleSubmit(event) {
        event.preventDefault();

        const timeValues = [];
        document.querySelectorAll('.time-input').forEach(input => {
            if (input.value) {
                timeValues.push(input.value);
            }
        });
        const timesString = timeValues.join(',');
        const daysString = document.getElementById('selectedDays').value;

        if (!timesString) {
            alert("복용 시간을 1개 이상 입력해주세요.");
            return false;
        }
        if (!daysString) {
            alert("복용 요일을 1개 이상 선택해주세요.");
            return false;
        }

        const formData = {
            category: document.getElementById('category').value,
            name: document.getElementById('name').value,
            memo: document.getElementById('memo').value,
            times: timesString,
            days: daysString,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value,
            doseUnitQuantity: parseInt(document.getElementById('doseUnitQuantity').value, 10),
            initialQuantity: parseInt(document.getElementById('initialQuantity').value, 10)
        };

        fetch('/api/medicines', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
        })
            .then(async response => {
                if (!response.ok) {
                    let errorText = `저장 실패 (${response.status})`;
                    try {
                        const errorJson = await response.json();
                        if (errorJson.errors) {
                            errorText = errorJson.errors.map(e => e.defaultMessage).join('\n');
                        } else if (errorJson.message) {
                            errorText = errorJson.message;
                        }
                    } catch (e) {
                    }
                    throw new Error(errorText);
                }
                return response.json();
            })
            .then(data => {
                alert(`[${data.name}] 약 정보가 성공적으로 저장되었습니다!`);
                document.getElementById('medicineForm').reset();
                document.querySelectorAll(".days button.active").forEach(btn => btn.classList.remove("active"));
                document.getElementById("time-container").innerHTML = '';
                document.getElementById("selectedDays").value = '';
                // window.location.href = '/medication_list.html';
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert(error.message);
            });

        return false;
    }
</script>

</body>
</html>