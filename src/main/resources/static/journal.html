<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚´ ë³µìš© ì¼ì§€</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 800px; margin: auto; }
        h1 { text-align: center; }
        .journal-entry {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .journal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .journal-time { font-size: 1.2em; font-weight: 600; color: #333; }
        .journal-emoji { font-size: 2em; }
        .journal-memo {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .journal-logs-list { list-style-type: none; padding-left: 0; }
        .log-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .log-detail-item:last-child { border-bottom: none; }
        .log-status { font-weight: bold; }
        .status-TAKEN { color: #28a745; }
        .status-SKIPPED { color: #ffc107; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“„ ë‚´ ë³µìš© ì¼ì§€</h1>
    <div style="text-align: center; margin-bottom: 20px;">
        <button onclick="location.href='/log_test.html'">+ ìƒˆ ê¸°ë¡/ì¼ì§€ ì‘ì„±í•˜ê¸°</button>
        <button onclick="fetchJournals()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>

    <div id="journal-list-container">
    </div>
</div>

<script>
    const journalListContainer = document.getElementById('journal-list-container');

    window.onload = function() {
        fetchJournals();
    };

    async function fetchJournals() {
        journalListContainer.innerHTML = '<p>ì¼ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
        try {
            // 1. [ì‹ ê·œ API] /api/journals í˜¸ì¶œ
            const response = await fetch('/api/journals');
            if (!response.ok) throw new Error('ì¼ì§€ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

            const journals = await response.json(); // List<JournalViewDto>

            if (journals.length === 0) {
                journalListContainer.innerHTML = '<p>ì‘ì„±ëœ ì¼ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            journalListContainer.innerHTML = ''; // ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸°

            // 2. ê° ì¼ì§€(Journal)ë¥¼ ë Œë”ë§
            journals.forEach(journal => {
                const journalTime = new Date(journal.journalTime).toLocaleString('ko-KR');

                // 3. ì¼ì§€ ë‚´ì˜ ê°œë³„ ë¡œê·¸(Log) ëª©ë¡ ë Œë”ë§
                let logsHtml = '<ul class="journal-logs-list">';
                journal.logs.forEach(log => {
                    const statusText = log.intakeStatus === 'TAKEN' ? 'ë³µìš© ì™„ë£Œ' : 'ê±´ë„ˆëœ€';
                    logsHtml += `
                        <li class="log-detail-item">
                            <span>${log.medicationName} (ì˜ˆì •: ${log.intakeTime.substring(0, 5)})</span>
                            <span class="log-status status-${log.intakeStatus}">${statusText}</span>
                        </li>
                    `;
                });
                logsHtml += '</ul>';

                // 4. ì „ì²´ ì¼ì§€ ì¹´ë“œ HTML
                journalListContainer.innerHTML += `
                    <div class="journal-entry">
                        <div class="journal-header">
                            <span class="journal-time">${journalTime}</span>
                            <span class="journal-emoji">${journal.conditionEmoji || ''}</span>
                        </div>
                        ${journal.logMemo ? `<div class="journal-memo">${journal.logMemo}</div>` : ''}
                        <h4>í¬í•¨ëœ ê¸°ë¡:</h4>
                        ${logsHtml}
                    </div>
                `;
            });

        } catch (error) {
            console.error(error);
            journalListContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;
        }
    }
</script>

</body>
</html>