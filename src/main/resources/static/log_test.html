<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì˜¤ëŠ˜ì˜ ë³µìš© ê¸°ë¡ (ê·¸ë£¹ ì €ì¥)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        .medication-group { border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .schedule-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .schedule-info { flex-grow: 1; }
        .schedule-info strong { font-size: 1.1em; }
        .schedule-info span { font-size: 0.9em; color: #555; }
        .log-checkbox { width: 20px; height: 20px; margin-right: 15px; }
        button { cursor: pointer; padding: 8px 12px; border-radius: 4px; border: 1px solid #007bff; background-color: #007bff; color: white; margin-left: 5px; }
        button.skip { background-color: #ffc107; border-color: #ffc107; }
        button.cancel { background-color: #6c757d; border-color: #6c757d; }
        .recorded { color: #28a745; font-weight: bold; }

        #journal-form {
            margin-top: 30px;
            padding: 20px;
            border-top: 2px solid #007bff;
            background: #f9f9f9;
            border-radius: 8px;
        }
        #journal-form h2 { margin-top: 0; }
        #journal-form div { margin-bottom: 10px; }
        #journal-form label { display: block; margin-bottom: 5px; font-weight: 500; }
        #journal-form input[type="datetime-local"],
        #journal-form input[type="text"],
        #journal-form textarea { width: 95%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        #journal-form button { background-color: #28a745; border: none; }
    </style>
</head>
<body>
<div class="container">
    <h1>ì˜¤ëŠ˜ì˜ ë³µìš© ê¸°ë¡</h1>
    <p>ì˜¤ëŠ˜ ë³µìš©í•  ì•½ ëª©ë¡ì…ë‹ˆë‹¤. ë¨¼ì € 'ê°œë³„ ì €ì¥'ì„ í•˜ì‹  í›„, 'ì¼ì§€ ì‘ì„±'ì„ ì§„í–‰í•˜ì„¸ìš”.</p>
    <button onclick="fetchAndDisplaySchedules()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>

    <div id="scheduleListContainer">
    </div>

    <div id="journal-form">
        <h2>ì„ íƒí•œ ì•½ ì¼ì§€ ì‘ì„±</h2>
        <p>
            'ë³µìš© ì™„ë£Œ' ë˜ëŠ” 'ê±´ë„ˆëœ€'ìœ¼ë¡œ <b>ì´ë¯¸ ê¸°ë¡ëœ</b> ì•½ë“¤ ì¤‘, ì¼ì§€ë¡œ ë¬¶ì„ í•­ëª©ì„ ìœ„ì—ì„œ ì²´í¬í•˜ì„¸ìš”.
            (ì•„ì§ ê¸°ë¡í•˜ì§€ ì•Šì€ ì•½ì€ ë¨¼ì € 'ê°œë³„ ì €ì¥'ì„ ëˆŒëŸ¬ ê¸°ë¡í•´ì•¼ í•©ë‹ˆë‹¤.)
        </p>
        <div>
            <label for="journal-time">ì¼ì§€ ì‘ì„± ì‹œê°</label>
            <input type="datetime-local" id="journal-time">
        </div>
        <div>
            <label for="journal-emoji">ì»¨ë””ì…˜ (ì´ëª¨ì§€)</label>
            <input type="text" id="journal-emoji" placeholder="ì˜ˆ: ğŸ˜Š">
        </div>
        <div>
            <label for="journal-memo">ì¦ìƒ/ë©”ëª¨</label>
            <textarea id="journal-memo" rows="3"></textarea>
        </div>
        <button onclick="submitJournal()">ì¼ì§€ ì €ì¥ (ê·¸ë£¹í™”)</button>
    </div>
</div>

<script>
    window.onload = function() {
        fetchAndDisplaySchedules();
        document.getElementById('journal-time').value = getCurrentDateTimeLocal();
    };

    const scheduleListContainer = document.getElementById('scheduleListContainer');

    function getCurrentDateTimeLocal() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        return now.toISOString().slice(0, 16);
    }

    // 1. 'ì˜¤ëŠ˜ì˜ ì•½' ëª©ë¡ ì¡°íšŒ (GET /api/medicines)
    async function fetchAndDisplaySchedules() {
        try {
            const response = await fetch('/api/medicines'); // (findAllWithLogs í˜¸ì¶œ)
            if (!response.ok) throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            const medicationsWithLogs = await response.json();

            scheduleListContainer.innerHTML = '';
            if (medicationsWithLogs.length === 0) {
                scheduleListContainer.innerHTML = '<p>í‘œì‹œí•  ì•½ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            medicationsWithLogs.forEach(med => {
                const medGroupDiv = document.createElement('div');
                medGroupDiv.className = 'medication-group';
                let schedulesHtml = `<h3>ğŸ’Š ${med.name}</h3>`;

                if (med.schedulesWithLogs && med.schedulesWithLogs.length > 0) {
                    med.schedulesWithLogs.forEach(sc => {
                        const isDisabled = (sc.logId != null);
                        let statusHtml = '';

                        if (isDisabled) {
                            // (A) ì´ë¯¸ ê¸°ë¡ëœ í•­ëª©: 'ì¼ì§€'ì— í¬í•¨í•  'ì²´í¬ë°•ìŠ¤' + 'ì·¨ì†Œ' ë²„íŠ¼
                            const statusText = sc.intakeStatus === 'TAKEN' ? 'ë³µìš© ì™„ë£Œ' : 'ê±´ë„ˆëœ€';
                            statusHtml = `
                                <input type="checkbox" class="log-checkbox" value="${sc.logId}">
                                <div class="schedule-info">
                                    <div class="log-header"><strong>${sc.intakeTime}</strong> <span class="recorded">(${statusText})</span></div>
                                    <span class="log-details">ì£¼ê¸°: ${sc.frequency}</span>
                                </div>
                                <button class="cancel" onclick="cancelIntake(${sc.logId})">ì·¨ì†Œ</button>
                            `;
                        } else {
                            // (B) ì•„ì§ ê¸°ë¡ ì•ˆ ëœ í•­ëª©: 'ê°œë³„ ì €ì¥' ë²„íŠ¼
                            statusHtml = `
                                <input type="checkbox" disabled title="ë¨¼ì € ê°œë³„ ê¸°ë¡ì„ ì™„ë£Œí•˜ì„¸ìš”">
                                <div class="schedule-info">
                                    <div class="log-header"><strong>${sc.intakeTime}</strong></div>
                                    <span class="log-details">ì£¼ê¸°: ${sc.frequency}</span>
                                </div>
                                <button onclick="recordIntake(${sc.scheduleId}, 'TAKEN')">ê°œë³„ ì €ì¥(ë³µìš©)</button>
                                <button class="skip" onclick="recordIntake(${sc.scheduleId}, 'SKIPPED')">ê°œë³„ ì €ì¥(ê±´ë„ˆëœ€)</button>
                            `;
                        }

                        schedulesHtml += `<div class="schedule-item">${statusHtml}</div>`;
                    });
                } else {
                    schedulesHtml += '<p>ì˜¤ëŠ˜ ì˜ˆì •ëœ ìŠ¤ì¼€ì¤„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
                medGroupDiv.innerHTML = schedulesHtml;
                scheduleListContainer.appendChild(medGroupDiv);
            });
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    // 2. 'ê°œë³„ ì €ì¥' (POST /api/logs/intake) í˜¸ì¶œ
    async function recordIntake(scheduleId, status) {
        if (!confirm(`'${status === 'TAKEN' ? 'ë³µìš© ì™„ë£Œ' : 'ê±´ë„ˆëœ€'}'ìœ¼ë¡œ ê¸°ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        // (MedicationLogDtoì— ë§ê²Œ 'recordTime'ì„ í¬í•¨í•˜ì—¬ ì „ì†¡)
        const payload = {
            scheduleId: scheduleId,
            intakeStatus: status,
            recordTime: getCurrentDateTimeLocal() + ":00"
        };

        try {
            const response = await fetch('/api/logs/intake', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            alert("ê°œë³„ ë³µìš© ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ì¼ì§€ì— í¬í•¨ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            fetchAndDisplaySchedules(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    // 3. 'ê·¸ë£¹ ì €ì¥' (POST /api/logs/journal) í˜¸ì¶œ
    async function submitJournal() {
        const checkedBoxes = document.querySelectorAll('.log-checkbox:checked:not(:disabled)');
        const logIds = Array.from(checkedBoxes).map(cb => parseInt(cb.value, 10));

        if (logIds.length === 0) {
            alert('ì¼ì§€ì— ì¶”ê°€í•  ê¸°ë¡ì„ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        const journalTime = document.getElementById('journal-time').value;
        const conditionEmoji = document.getElementById('journal-emoji').value;
        const logMemo = document.getElementById('journal-memo').value;

        if (!journalTime) {
            alert('ì¼ì§€ ì‘ì„± ì‹œê°ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        const payload = {
            logIds: logIds,
            journalTime: journalTime + ":00",
            conditionEmoji: conditionEmoji || null,
            logMemo: logMemo || null
        };

        try {
            const response = await fetch('/api/logs/journal', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'ì¼ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }

            alert('ë³µìš© ì¼ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            fetchAndDisplaySchedules(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨

        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }

    // 4. 'ê¸°ë¡ ì·¨ì†Œ' (DELETE /api/logs/{logId})
    async function cancelIntake(logId) {
        if (!confirm('ì´ ë³µìš© ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì—°ê²°ëœ ì¼ì§€ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')) return;

        try {
            const response = await fetch(`/api/logs/${logId}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            alert('ë³µìš© ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            fetchAndDisplaySchedules();
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    }
</script>
</body>
</html>